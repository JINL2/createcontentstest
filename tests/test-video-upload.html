<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Upload Test - Contents Helper</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #FF6B35;
            text-align: center;
        }
        .upload-area {
            border: 2px dashed #FF6B35;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #fff5f0;
            transition: all 0.3s;
        }
        .upload-area:hover {
            background: #ffe8e0;
            border-color: #E55100;
        }
        input[type="file"] {
            display: none;
        }
        .upload-label {
            cursor: pointer;
            display: block;
            font-size: 18px;
        }
        .upload-icon {
            font-size: 48px;
            display: block;
            margin-bottom: 10px;
        }
        button {
            background: #FF6B35;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        button:hover {
            background: #E55100;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #video-preview {
            max-width: 100%;
            margin: 20px auto;
            display: none;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .info-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .url-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 3px;
            word-break: break-all;
            font-family: monospace;
            font-size: 14px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ Video Upload Test</h1>
        
        <div class="info-section">
            <h3>í…ŒìŠ¤íŠ¸ ì •ë³´</h3>
            <p><strong>User ID:</strong> <span id="user-id">0d2e61ad-e230-454e-8b90-efbe1c1a9268</span></p>
            <p><strong>User Name:</strong> <span id="user-name">Jin</span></p>
            <p><strong>Content ID:</strong> <span id="content-id">test-content-001</span></p>
        </div>

        <div class="upload-area">
            <input type="file" id="video-file" accept="video/*">
            <label for="video-file" class="upload-label">
                <span class="upload-icon">ğŸ“</span>
                <p>ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</p>
                <span style="color: #666; font-size: 14px;">MP4, MOV, AVI (ìµœëŒ€ 50MB)</span>
            </label>
        </div>

        <video id="video-preview" controls></video>

        <div style="text-align: center;">
            <button id="upload-btn" disabled>ğŸš€ ì—…ë¡œë“œ ì‹œì‘</button>
            <button id="check-storage">ğŸ“¦ Storage í™•ì¸</button>
            <button id="check-uploads">ğŸ“‹ ì—…ë¡œë“œ ëª©ë¡ í™•ì¸</button>
        </div>

        <div id="status" class="status"></div>
        
        <div id="result" style="display: none;">
            <h3>ì—…ë¡œë“œ ê²°ê³¼</h3>
            <p><strong>Video URL:</strong></p>
            <div class="url-display" id="video-url"></div>
            <p><strong>Upload ID:</strong> <span id="upload-id"></span></p>
        </div>
    </div>

    <script>
        // Supabase ì´ˆê¸°í™”
        const supabaseUrl = 'https://yenfccoefczqxckbizqa.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllbmZjY29lZmN6cXhja2JpenFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5NDkyNzksImV4cCI6MjA2MTUyNTI3OX0.U1iQUOaNPSrEHf1w_ePqgYzJiRO6Bi48E2Np2hY0nCQ';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        // ì „ì—­ ë³€ìˆ˜
        let selectedFile = null;

        // ìƒíƒœ í‘œì‹œ í•¨ìˆ˜
        function showStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
            status.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        // íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
        document.getElementById('video-file').addEventListener('change', function(e) {
            e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ì§€
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                
                // íŒŒì¼ ì •ë³´ í‘œì‹œ
                showStatus(`ì„ íƒëœ íŒŒì¼: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`, 'success');
                
                // ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸°
                const videoPreview = document.getElementById('video-preview');
                videoPreview.src = URL.createObjectURL(file);
                videoPreview.style.display = 'block';
                
                // ì—…ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
                document.getElementById('upload-btn').disabled = false;
            }
        });

        // ë¹„ë””ì˜¤ ì—…ë¡œë“œ í•¨ìˆ˜
        async function uploadVideo() {
            if (!selectedFile) return;

            const userId = document.getElementById('user-id').textContent;
            const contentId = document.getElementById('content-id').textContent;

            try {
                showStatus('ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì¤‘...', 'loading');

                // íŒŒì¼ëª… ìƒì„±
                const timestamp = Date.now();
                const fileExt = selectedFile.name.split('.').pop();
                const fileName = `${userId}_${contentId}_${timestamp}.${fileExt}`;
                const filePath = `videos/${fileName}`;

                console.log('ì—…ë¡œë“œ ì‹œì‘:', filePath);

                // Storageì— ì—…ë¡œë“œ
                const { data, error } = await supabase.storage
                    .from('contents-videos')
                    .upload(filePath, selectedFile, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    throw error;
                }

                // Public URL ê°€ì ¸ì˜¤ê¸°
                const { data: { publicUrl } } = supabase.storage
                    .from('contents-videos')
                    .getPublicUrl(filePath);

                console.log('ì—…ë¡œë“œ ì„±ê³µ! URL:', publicUrl);

                // content_uploads í…Œì´ë¸”ì— ì €ì¥
                const { data: uploadData, error: dbError } = await supabase
                    .from('content_uploads')
                    .insert({
                        content_id: contentId,
                        user_id: userId,
                        upload_url: publicUrl,
                        file_name: selectedFile.name,
                        upload_time: new Date().toISOString(),
                        status: 'uploaded',
                        metadata: {
                            original_name: selectedFile.name,
                            file_size: selectedFile.size,
                            upload_source: 'test_page'
                        }
                    })
                    .select()
                    .single();

                if (dbError) {
                    throw dbError;
                }

                // ê²°ê³¼ í‘œì‹œ
                showStatus('ì—…ë¡œë“œ ì„±ê³µ!', 'success');
                document.getElementById('result').style.display = 'block';
                document.getElementById('video-url').textContent = publicUrl;
                document.getElementById('upload-id').textContent = uploadData.id;

            } catch (error) {
                console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showStatus(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // Storage í™•ì¸
        async function checkStorage() {
            try {
                showStatus('Storage í™•ì¸ ì¤‘...', 'loading');
                
                const { data, error } = await supabase.storage
                    .from('contents-videos')
                    .list('videos', {
                        limit: 10,
                        offset: 0
                    });

                if (error) {
                    throw error;
                }

                console.log('Storage íŒŒì¼ ëª©ë¡:', data);
                showStatus(`Storageì— ${data.length}ê°œì˜ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤.`, 'success');

            } catch (error) {
                console.error('Storage í™•ì¸ ì‹¤íŒ¨:', error);
                showStatus(`Storage í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ì—…ë¡œë“œ ëª©ë¡ í™•ì¸
        async function checkUploads() {
            try {
                showStatus('ì—…ë¡œë“œ ëª©ë¡ í™•ì¸ ì¤‘...', 'loading');
                
                const userId = document.getElementById('user-id').textContent;
                const { data, error } = await supabase
                    .from('content_uploads')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                if (error) {
                    throw error;
                }

                console.log('ì—…ë¡œë“œ ëª©ë¡:', data);
                showStatus(`${data.length}ê°œì˜ ì—…ë¡œë“œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`, 'success');

                // ì½˜ì†”ì— ìƒì„¸ ì •ë³´ ì¶œë ¥
                data.forEach((upload, index) => {
                    console.log(`${index + 1}. ${upload.file_name} - ${upload.upload_url}`);
                });

            } catch (error) {
                console.error('ì—…ë¡œë“œ ëª©ë¡ í™•ì¸ ì‹¤íŒ¨:', error);
                showStatus(`ì—…ë¡œë“œ ëª©ë¡ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('upload-btn').addEventListener('click', uploadVideo);
        document.getElementById('check-storage').addEventListener('click', checkStorage);
        document.getElementById('check-uploads').addEventListener('click', checkUploads);

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        console.log('Video Upload Test í˜ì´ì§€ ë¡œë“œë¨');
        console.log('Supabase í´ë¼ì´ì–¸íŠ¸:', supabase);
    </script>
</body>
</html>